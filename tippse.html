<html>
<head>
  <style>
    body {background-color:#000;}
    #tippse {width:100%; height:100%; overflow:hidden; border:1px solid #000; margin:0; padding:0; position:relative; background-color:#000;}
    #tippse_monospaced {font-family:monospace; position:absolute; margin:0; padding:0; top:-10em; left:-10em;}
    .tippse_text {font-family:monospace; position:absolute; margin:0; padding:0;}
  </style>
  <script type="text/javascript">
    var TIPPSE_KEY_MOD_SHIFT = 0x1000;
    var TIPPSE_KEY_MOD_CTRL = 0x2000;
    var TIPPSE_KEY_MOD_ALT = 0x4000;
    var TIPPSE_KEY_MASK = 0xfff;

    var TIPPSE_KEY_CHARACTER = 0;
    var TIPPSE_KEY_UP = 1;
    var TIPPSE_KEY_DOWN = 2;
    var TIPPSE_KEY_RIGHT = 3;
    var TIPPSE_KEY_LEFT = 4;
    var TIPPSE_KEY_PAGEUP = 5;
    var TIPPSE_KEY_PAGEDOWN = 6;
    var TIPPSE_KEY_BACKSPACE = 7;
    var TIPPSE_KEY_DELETE = 8;
    var TIPPSE_KEY_INSERT = 9;
    var TIPPSE_KEY_FIRST = 10;
    var TIPPSE_KEY_LAST = 11;
    var TIPPSE_KEY_TAB = 12;
    var TIPPSE_KEY_MOUSE = 13;
    var TIPPSE_KEY_RETURN = 14;
    var TIPPSE_KEY_BRACKET_PASTE_START = 15;
    var TIPPSE_KEY_BRACKET_PASTE_STOP = 16;
    var TIPPSE_KEY_ESCAPE = 17;
    var TIPPSE_KEY_F1 = 18;
    var TIPPSE_KEY_F2 = 19;
    var TIPPSE_KEY_F3 = 20;
    var TIPPSE_KEY_F4 = 21;
    var TIPPSE_KEY_F5 = 22;
    var TIPPSE_KEY_F6 = 23;
    var TIPPSE_KEY_F7 = 24;
    var TIPPSE_KEY_F8 = 25;
    var TIPPSE_KEY_F9 = 26;
    var TIPPSE_KEY_F10 = 27;
    var TIPPSE_KEY_F11 = 28;
    var TIPPSE_KEY_F12 = 29;
    var TIPPSE_KEY_MAX = 30;

    var tippse_key_state = {};
    var tippse_key_map = {
      "ArrowUp":1,
      "ArrowDown":2,
      "ArrowRight":3,
      "ArrowLeft":4,
      "PageUp":5,
      "PageDown":6,
      "Backspace":7,
      "Delete":8,
      "Insert":9,
      "Home":10,
      "End":11,
      "Tab":12,
      "Enter":14,
      "Escape":17,
      "F1":17,
      "F2":17,
      "F3":17,
      "F4":17,
      "F5":17,
      "F6":17,
      "F7":17,
      "F8":17,
      "F9":17,
      "F10":17,
      "F11":17,
      "F12":17
    };

    var tippse_screen = [];
    var tippse_char_size_x = 0;
    var tippse_char_size_y = 0;
    function tippse_resize() {
      var monospaced = document.getElementById("tippse_monospaced");
      var draw_area = document.getElementById("tippse");
      tippse_char_size_x = monospaced.offsetWidth;
      tippse_char_size_y = monospaced.offsetHeight;
      var width = draw_area.offsetWidth/tippse_char_size_x;
      var height = draw_area.offsetHeight/tippse_char_size_y;
      tippse_screen = [];
      Module._tippse_resize(width, height);
    }

    function tippse_tick() {
      Module._tippse_tick();
    }

    function tippse_keydown(e) {
      console.log("keydown", e.key);
      if (e.key=="Control" || e.key=="Shift" || e.key=="Alt") {
        tippse_key_state[e.key] = true;
      } else {
        var code = 0;
        var key = tippse_key_map[e.key];
        if (key===undefined) {
          key = 0;
          code = e.key.charCodeAt(0);
        }
        if (tippse_key_state["Shift"]) {
          key |= TIPPSE_KEY_MOD_SHIFT;
        }
        if (tippse_key_state["Control"]) {
          key |= TIPPSE_KEY_MOD_CTRL;
        }
        if (tippse_key_state["Alt"]) {
          key |= TIPPSE_KEY_MOD_ALT;
        }
        Module._tippse_keypress(key, code, 0, 0, 0, 0);
      }
      e.preventDefault();
      return false;
    }

    function tippse_keyup(e) {
      console.log("keyup", e.key);
      if (e.key=="Control" || e.key=="Shift" || e.key=="Alt") {
        tippse_key_state[e.key] = false;
      }
      e.preventDefault();
      return false;
    }

    function tippse_load() {
      console.log("load");
      Module._tippse_init();
      tippse_resize();
      setInterval(tippse_tick, 100);
      document.addEventListener('keydown', tippse_keydown);
      document.addEventListener('keyup', tippse_keyup);
    }

    function tippse_draw_char(x, y, text, length, foreground, background) {
      if (tippse_screen[y]===undefined) {
        tippse_screen[y] = [];
      }

      if (tippse_screen[y][x]===undefined) {
        var e = document.createElement("div");
        e.className = "tippse_text";
        e.style.top = y*tippse_char_size_y+"px";
        e.style.left = x*tippse_char_size_x+"px";
        document.getElementById("tippse").appendChild(e);
        tippse_screen[y][x] = e;
      }

      if (foreground==-1) {
        foreground = 0xc0c0c0;
      } else if (foreground==-2) {
        foreground = 0x000000;
      } else if (foreground==-3) {
        foreground = 0x000000;
      }

      if (background<0 || background>0xffffff) {
        background = 0x000000;
      } else if (background==-2) {
        background = 0x000000;
      } else if (background==-3) {
        background = 0x000000;
      }

      tippse_screen[y][x].textContent = UTF8ToString(text, length);
      tippse_screen[y][x].style.color = "#"+foreground.toString(16);
      tippse_screen[y][x].style.backgroundColor = "#"+background.toString(16);
    }
  </script>
  <script type="text/javascript" src="tippse.js"></script>
</head>
<body>
<div id="tippse">
<span id="tippse_monospaced">&#xa0;</span>
</div>
</body>
</html>